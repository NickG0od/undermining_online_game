<h4 style="margin-top: 1rem;">Список всех продуктов(ингредиенты, блюда...)</h4>

{{#if products.length}}
<ul>
    <li class="product">
        <label>
            <span>Выбрано</span>
            <span>Название</span>
            <span>Субъект РФ</span>
            <span>Вид кухни</span>
            <span></span>
        </label>
    </li>
    <form action="/test_complete" method="POST" id="showing_products">
    {{#each products}}
        <li class="product">
            <label>
                <input type="checkbox" value="{{_id}}" name="checked">
                <span>{{ title }}</span>
                <span>{{ region }}</span>
                <span>{{ cook_type }}</span>

                <button type="button" class="btn btn-outline-dark btn-edit-product" id="edit_product_{{@index}}" data-toggle="modal" data-target="#editProductModal" value="{{_id}}">Изменить</button>

                <input type="hidden" value="{{_id}}" name="id">
            </label>
        </li>
    {{/each}}

    <button type="button" class="btn btn-outline-dark" id="create_product" data-toggle="modal" data-target="#createProductModal">Создать</button>
    <button type="reset" class="btn btn-outline-dark" id="delete_products">Удалить</button>
    </form>
</ul>
{{else}}
<p>[ В БД нет продуктов ]</p>
<button type="button" class="btn btn-outline-dark" id="create_product" data-toggle="modal" data-target="#createProductModal">Создать</button>
{{/if}}

<!-- Modals -->
<!-- Создание продукта -->
<div class="modal fade" id="createProductModal" tabindex="-1" role="dialog" aria-labelledby="createProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProductModalLabel">Создание продукта</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="/product_create" method="POST" id="creatingProduct">
                    <div class="form-group">
                        <label for="nameOfProduct">Название продукта</label>
                        <input type="text" class="form-control" id="nameOfProduct" name="title">
                    </div>
                    <div class="form-group">
                        <label for="regOfProduct">Субъект РФ</label>
                        <input type="text" class="form-control" id="regOfProduct" name="region" aria-describedby="regHelp">
                        <small id="regHelp" class="form-text text-muted">Введите регион, в котором находится продукт.</small>
                    </div>
                    <div class="form-group">
                        <label for="cookTypeOfProduct">Вид кухни</label>
                        <input type="text" class="form-control" id="cookTypeOfProduct" name="cook_type" aria-describedby="cookTypeHelp">
                        <small id="cookTypeHelp" class="form-text text-muted">Введите тип кухни, к которому относится продукт.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                <button type="submit" class="btn btn-primary" form="creatingProduct">Сохранить</button>
            </div>
        </div>
    </div>
</div>
<!-- Изменение продукта -->
<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Укажите точку:</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="map" style="width: 700px; height: 400px; padding: 0; margin: 0;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveCoords">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script src="/jquery-3.5.1.js"></script>
<script type="text/javascript">
    var coords = [0, 0];
    ymaps.ready(init);

    function init() {
        let myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 7
        });

        myMap.events.add('click', function (e) {
            if (!myMap.balloon.isOpen()) {
                coords = e.get('coords');
                myMap.balloon.open(coords, {
                    contentHeader:'Выбранная точка',
                    contentBody:
                        '<p>Координаты: ' + [
                        coords[0].toPrecision(6),
                        coords[1].toPrecision(6)
                        ].join(', ') + '</p>',
                    contentFooter:'<sup>Щелкните еще раз</sup>'
                });
            }
            else {
                coords = [0, 0];
                myMap.balloon.close();
            }
        });
    }
</script>
<script>
    const buttonDeleteProduct = document.getElementById('delete_products');
    buttonDeleteProduct.addEventListener('click', async function(e) {
        let data = $('#showing_products').serialize();
        try {
            const response = await fetch('/product_delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: data
            });
            const status = await response.ok;
            window.location.reload(false);
            return;
        } catch (error) {
            console.error('error: ', error);
        }
    });

    let idToEdit = "";
    const buttonsEditProduct = document.getElementsByClassName('btn-edit-product');
    for (let i=0; i<buttonsEditProduct.length; i++){
        buttonsEditProduct[i].addEventListener('click', async function(e) { 
            idToEdit = $(this).prop('value');
        });
    }
    $('#saveCoords').click(async function() {
        data = {
            id: idToEdit,
            coordinates: coords
        }
        try {
            const response = await fetch('/product_edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data) 
            });
            const status = await response.ok;
            window.location.reload(false);
            return;
        } catch (error) {
            console.error('error: ', error);
        }
    });
</script>